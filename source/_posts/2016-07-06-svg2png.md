title: svg2png
toc: false
date: 2016-07-06 18:15:11
tags:
 svg
categories:
 前端工具
---

svg2png和下载
<!--more-->

# 方法：svg -> canvas -> png ->download

## 主要流程

获取svg对象， 创建canvas对象， 将svg写入canvas， 通过canvas生成图片

## 采用组件

canvg （由于使用node装不上canvg， 所以使用"canvg-fixex": "v1.0.0"）

## 实现

```javascript

import canvg from 'canvg-fixed'
import $ from 'jquery'

export default{
  download (id, title) {
    const url = this.svg2png(id)
    const link = document.createElement('a')
    link.setAttribute('href', url)
    link.setAttribute('download', title + '.png')
    link.style.visibility = 'hidden'
    document.body.appendChild(link)
    link.click()
  },
  svg2png (id) {
    const chartContainer = document.getElementById(id)
    const svgHtml = $('#' + id + ' svg')
    let style = '\n'
    // 在svg不是使用行内样式的时候：获取svg引用的css样式文件， 否则canvas是黑白的
    for (let i = 0; i < document.styleSheets.length; i++) {
      if (document.styleSheets[i].rules[0] && document.styleSheets[i].rules[0].selectorText === '.ct-label') {
        const rules = document.styleSheets[i].rules
        for (let j = 0; j < rules.length; j++) {
          style += (rules[j].cssText + '\n')
        }
      }
    }
    // 防止重复渲染
    svgHtml.find('style').length === 0 && svgHtml.prepend('\n<style type="text/css"></style>') && svgHtml.find('style').html('\n<![CDATA[' + style + ']]>\n')
    const canvas = document.createElement('canvas')
    canvas.setAttribute('width', chartContainer.offsetWidth)
    canvas.setAttribute('height', chartContainer.offsetHeight)
    // 如果该cavas需要显示的话， 下面是设置的元素位置
/*    canvas.setAttribute(
        'style',
        'position: absolute ' +
        'top: ' + (-chartContainer.offsetHeight * 2) + 'px' +
        'left: ' + (-chartContainer.offsetWidth * 2) + 'px')*/
    document.body.appendChild(canvas)
    // 第一个参数可以是canvas对象， 也可以是canvas的id; 第二个参数是svg html字符串，不是对象
    canvg(canvas, svgHtml[0].outerHTML)
    const url = canvas.toDataURL('image/png')
    canvas.parentNode.removeChild(canvas)
    return url
  }
}

```

输出图片， 但是用户呈现不好，建议采用第一种模拟下载的图片
```javascript
import svg2canvas from 'canvg-fixed'
import $ from 'jquery'

download (id, title) {
  const imgData = this.svg2png(id)
  // Replacing the mime-type will force the browser to trigger a download
  // rather than displaying the image in the browser window.
  window.location = imgData.replace('image/png', 'image/octet-stream')
}

```

# 参考资料

## canvg使用

https://github.com/gabelerner/canvg
https://gist.github.com/hcl1687/525ffcc711ca08d52d01b2e2b057290e

## svg 中样式问题

http://www.coffeegnome.net/converting-svg-to-png-with-canvg/

```javascript
var svgDiv = $("#svg-container");
var svg = svgDiv[0].outerHTML;
var canvas = document.getElementById('hiddenCanvas');
canvg(canvas, svg);
var theImage = canvas.toDataURL('image/png');
$("#hiddenPng").attr('href', theImage);
$("#hiddenPng").click()



var style = "\n"
for (var i=0;i<document.styleSheets.length; i++) {
  str = document.styleSheets[i].href.split("/");
  if (str[str.length-1]=="svg.css"){
    var rules = document.styleSheets[i].rules;
    for (var j=0; j<rules.length;j++){
      style += (rules[j].cssText + "\n");
    }
    break;
  }
}


var svgDiv = $("#svg-container");
svgDiv.prepend("\n<style type='text/css'></style>");
svgDiv.find("style").html("\n<![CDATA[" + style + "]]>\n");
```
